# PRD: 临床科室审核

## 功能概述

临床科室审核模块提供对"药品不良反应报告"和"不良事件"的统一审核入口。临床审核人员可以在此模块查看本科室待审核的所有报告，进行审核通过或退回操作。

## 业务背景

根据《北京市石景山医院不良事件上报系统需求规格说明书》3.2 科室审核功能要求：
- 临床审核人员需要审核本科室上报的事件/报告
- 审核通过后流转至对应职能科室处理
- 审核退回需填写退回原因，上报人可修改后重新提交

## 菜单结构

### 一级菜单
- **菜单名称**: 临床科室审核
- **菜单路径**: /adverse/clinic-audit
- **菜单图标**: ant-design:audit-outlined
- **显示顺序**: 在"报告审核"之后

### 二级菜单

| 菜单名称 | 路径 | 说明 |
|---------|------|------|
| 药品不良反应审核 | /adverse/clinic-audit/drug | 审核本科室的药品不良反应报告 |
| 不良事件审核 | /adverse/clinic-audit/event | 审核本科室的不良事件报告 |

## 功能模块

### 1. 药品不良反应审核

#### 1.1 待审核列表

**页面路径**: `/adverse/clinic-audit/drug`

**功能描述**:
- 展示当前用户所在科室待审核的药品不良反应报告列表
- 支持按报告编号、患者姓名、上报时间等条件筛选

**列表字段**:

| 字段名 | 显示名称 | 说明 |
|-------|---------|------|
| reportNo | 报告编号 | 自动生成的报告编号 |
| patientName | 患者姓名 | 脱敏显示 |
| patientGender | 患者性别 | - |
| patientAge | 患者年龄 | - |
| adverseReaction | 不良反应名称 | 主要不良反应描述 |
| reporterName | 上报人 | 上报人姓名 |
| createTime | 上报时间 | - |
| status | 状态 | pending_audit-待审核 |

**操作按钮**:
- 查看: 查看报告详情（只读模式）
- 审核: 打开审核弹窗，进行审核操作

#### 1.2 已审核列表

**页面说明**: 通过 Tab 切换查看已审核记录

**列表额外字段**:

| 字段名 | 显示名称 | 说明 |
|-------|---------|------|
| auditStatus | 审核结果 | passed-通过 / rejected-退回 |
| auditTime | 审核时间 | - |
| auditComment | 审核意见 | - |

#### 1.3 审核弹窗

**弹窗组件**: DrugAuditModal.vue

**表单字段**:

| 字段名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| action | 单选 | 是 | pass-审核通过 / reject-审核退回 |
| comment | 多行文本 | 退回时必填 | 审核意见，退回时必须填写退回原因 |

### 2. 不良事件审核

#### 2.1 待审核列表

**页面路径**: `/adverse/clinic-audit/event`

**功能描述**:
- 复用现有 `/adverse/audit` 模块的逻辑
- 展示当前用户所在科室待审核的不良事件列表

**列表字段**: 复用 event.data.ts 中的列定义

#### 2.2 已审核列表

复用现有 CompletedList.vue 组件逻辑

## API 设计

### 药品不良反应审核 API

#### 1. 获取待审核列表

```
GET /adverse/drug/audit/pending
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| pageNo | int | 否 | 页码，默认 1 |
| pageSize | int | 否 | 每页条数，默认 10 |
| reportNo | string | 否 | 报告编号筛选 |
| patientName | string | 否 | 患者姓名模糊查询 |

**响应示例**:
```json
{
  "success": true,
  "result": {
    "records": [...],
    "total": 100,
    "current": 1,
    "size": 10
  }
}
```

#### 2. 获取已审核列表

```
GET /adverse/drug/audit/completed
```

**请求参数**: 同待审核列表

#### 3. 审核通过

```
POST /adverse/drug/audit/pass
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| id | string | 是 | 报告ID |
| comment | string | 否 | 审核意见 |

#### 4. 审核退回

```
POST /adverse/drug/audit/reject
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| id | string | 是 | 报告ID |
| comment | string | 是 | 退回原因 |

## 数据库设计

### 药品不良反应报告表扩展字段

在现有 `drug_adverse_report` 表中添加或确认以下字段：

| 字段名 | 类型 | 说明 |
|-------|------|------|
| status | varchar(32) | 报告状态：draft/pending_audit/returned/pending_process/... |
| audit_user_id | varchar(32) | 审核人ID |
| audit_user_name | varchar(100) | 审核人姓名 |
| audit_time | datetime | 审核时间 |
| audit_comment | text | 审核意见 |

### 审核流转记录表

复用现有 `adverse_event_flow` 表结构，或新建 `drug_adverse_flow` 表：

```sql
CREATE TABLE drug_adverse_flow (
  id VARCHAR(32) PRIMARY KEY COMMENT '主键',
  report_id VARCHAR(32) NOT NULL COMMENT '关联报告ID',
  action VARCHAR(32) NOT NULL COMMENT '操作类型：submit/audit_pass/audit_reject/...',
  from_status VARCHAR(32) COMMENT '操作前状态',
  to_status VARCHAR(32) COMMENT '操作后状态',
  operator_id VARCHAR(32) COMMENT '操作人ID',
  operator_name VARCHAR(100) COMMENT '操作人姓名',
  comment TEXT COMMENT '操作备注',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) COMMENT '药品不良反应流转记录表';
```

## 权限设计

### 菜单权限

| 权限编码 | 权限名称 | 说明 |
|---------|---------|------|
| adverse:clinic:audit | 临床科室审核 | 一级菜单权限 |
| adverse:clinic:audit:drug | 药品不良反应审核 | 二级菜单权限 |
| adverse:clinic:audit:event | 不良事件审核 | 二级菜单权限 |

### 按钮权限

| 权限编码 | 权限名称 |
|---------|---------|
| adverse:clinic:audit:drug:view | 查看药品报告详情 |
| adverse:clinic:audit:drug:pass | 审核通过 |
| adverse:clinic:audit:drug:reject | 审核退回 |

### 数据权限

- 临床审核人员只能查看和审核**本科室**上报的报告
- 通过 `department_id` 字段与登录用户的 `orgCode` 匹配实现数据隔离

## 前端实现

### 新增组件

1. **页面组件**
   - `jeecgboot-vue3/src/views/adverse/clinic-audit/index.vue` - 一级菜单入口
   - `jeecgboot-vue3/src/views/adverse/clinic-audit/drug/index.vue` - 药品审核页面
   - `jeecgboot-vue3/src/views/adverse/clinic-audit/drug/PendingList.vue` - 待审核列表
   - `jeecgboot-vue3/src/views/adverse/clinic-audit/drug/CompletedList.vue` - 已审核列表
   - `jeecgboot-vue3/src/views/adverse/clinic-audit/event/index.vue` - 事件审核页面

2. **公共组件**
   - `jeecgboot-vue3/src/views/adverse/components/DrugAuditModal.vue` - 药品审核弹窗
   - `jeecgboot-vue3/src/views/adverse/components/DrugReportDetailModal.vue` - 药品报告详情弹窗

3. **API 文件**
   - `jeecgboot-vue3/src/api/adverse/drugAudit.ts` - 药品审核 API

### 路由配置

在 `adverse.ts` 路由文件中添加：

```typescript
// ========== 临床科室审核 ==========
{
  path: 'clinic-audit',
  name: 'AdverseClinicAudit',
  component: () => import('/@/views/adverse/clinic-audit/index.vue'),
  redirect: '/adverse/clinic-audit/drug',
  meta: {
    title: '临床科室审核',
    icon: 'ant-design:audit-outlined',
  },
  children: [
    {
      path: 'drug',
      name: 'AdverseClinicAuditDrug',
      component: () => import('/@/views/adverse/clinic-audit/drug/index.vue'),
      meta: {
        title: '药品不良反应审核',
      },
    },
    {
      path: 'event',
      name: 'AdverseClinicAuditEvent',
      component: () => import('/@/views/adverse/clinic-audit/event/index.vue'),
      meta: {
        title: '不良事件审核',
      },
    },
  ],
},
```

## 后端实现

### 新增 Controller

- `DrugAuditController.java` - 药品不良反应审核控制器

### Service 扩展

在 `IDrugAdverseReportService` 中添加方法：
- `getPendingAuditList()` - 获取待审核列表
- `getCompletedAuditList()` - 获取已审核列表
- `auditPass()` - 审核通过
- `auditReject()` - 审核退回
- `canAudit()` - 判断是否可审核

## 任务拆分

### Phase 1: 数据库设计
1. 确认 drug_adverse_report 表状态字段
2. 创建 drug_adverse_flow 流转记录表
3. 创建菜单 SQL 脚本

### Phase 2: 后端开发
1. 创建 DrugAuditController
2. 扩展 IDrugAdverseReportService 审核方法
3. 实现审核流转记录

### Phase 3: 前端开发
1. 创建路由配置
2. 创建页面组件
3. 创建审核弹窗组件
4. 实现 API 调用

### Phase 4: 权限配置
1. 配置菜单权限
2. 配置按钮权限
3. 实现数据权限过滤

## 验收标准

- [ ] 临床审核人员可以查看本科室待审核的药品不良反应报告
- [ ] 可以查看报告详情（只读模式）
- [ ] 可以审核通过，报告状态变更为"待处理"
- [ ] 可以审核退回，必须填写退回原因，报告状态变更为"已退回"
- [ ] 已审核记录可以在"已审核"列表中查看
- [ ] 审核操作生成流转记录
- [ ] 不同科室的审核人员只能看到本科室的数据

---

> 由 /jeecg:prd 命令生成
> 创建时间: 2025-12-19
