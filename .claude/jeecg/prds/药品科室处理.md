# PRD: 药品科室处理

## 基本信息

- **项目**: shijingshan
- **功能**: 药品科室处理
- **创建时间**: 2025-12-19
- **框架**: JeecgBoot 3.8.x
- **前置功能**: 临床科室审核（Epic #43，已完成）

## 功能概述

药品科室处理模块是药品不良反应报告流程的核心环节。当临床科室审核通过后，报告流转至药剂科进行处理。药剂科人员可以查看待处理的报告，根据情况选择：
1. **直接结案**: 报告信息完整，无需整改
2. **要求整改**: 下发整改要求，等待临床人员填写整改措施后确认

## 业务背景

根据《北京市石景山医院不良事件上报系统需求规格说明书》3.3 职能科室处理功能要求：
- 待处理列表: 查看流转至本科室的事件
- 事件详情: 查看事件详细信息及流转记录
- 要求整改: 下发整改要求，填写整改意见
- 直接结案: 无需整改，直接结案处理
- 待确认列表: 查看已提交整改待确认的事件
- 确认整改: 确认整改完成，事件结案
- 再次整改: 整改不到位，要求再次整改
- 已结案列表: 查看已结案的事件记录

## 状态流程

```
                                  ┌────────────────┐
                                  │   待处理       │
                                  │ pending_process│
                                  └───────┬────────┘
                                          │
                         ┌────────────────┼────────────────┐
                         │                │                │
                         ▼                │                ▼
                 ┌──────────────┐         │         ┌──────────────┐
                 │   直接结案    │         │         │   要求整改   │
                 └──────┬───────┘         │         └──────┬───────┘
                        │                 │                │
                        ▼                 │                ▼
                 ┌──────────────┐         │         ┌──────────────┐
                 │   已结案     │         │         │   待整改     │
                 │   closed     │         │         │pending_rectify│
                 └──────────────┘         │         └──────┬───────┘
                                          │                │
                                          │                ▼
                                          │         ┌──────────────┐
                                          │         │  临床人员    │
                                          │         │  填写整改    │
                                          │         └──────┬───────┘
                                          │                │
                                          │                ▼
                                          │         ┌──────────────┐
                                          │         │   整改中     │
                                          │         │  rectifying  │
                                          │         └──────┬───────┘
                                          │                │
                                          │     ┌──────────┼──────────┐
                                          │     │          │          │
                                          │     ▼          │          ▼
                                          │ ┌────────┐     │     ┌────────┐
                                          │ │确认整改│     │     │再次整改│
                                          │ └───┬────┘     │     └───┬────┘
                                          │     │          │         │
                                          │     ▼          │         ▼
                                          │ ┌────────┐     │  ┌──────────────┐
                                          └─│ 结案   │     │  │   待整改     │
                                            │ closed │     │  │pending_rectify│
                                            └────────┘     │  └──────────────┘
                                                           │         │
                                                           └─────────┘
```

## 菜单结构

### 一级菜单
- **菜单名称**: 药品科室处理
- **菜单路径**: /adverse/drug-process
- **菜单图标**: ant-design:experiment-outlined
- **父级菜单**: 不良事件管理 (ae_root)
- **显示顺序**: 在"临床科室审核"之后

### 页面 Tab
| Tab名称 | 说明 |
|---------|------|
| 待处理 | 待处理的药品不良反应报告 |
| 待确认 | 已提交整改，等待确认的报告 |
| 已结案 | 已完成处理的报告 |

## 功能模块

### 1. 待处理列表

**功能描述**:
- 展示所有状态为"待处理"(pending_process) 的药品不良反应报告
- 支持按报告编号、患者姓名、上报科室等条件筛选

**列表字段**:

| 字段名 | 显示名称 | 说明 |
|-------|---------|------|
| reportCode | 报告编号 | 自动生成的报告编号 |
| reportType | 报告类型 | 首次报告/跟踪报告 |
| severityType | 严重程度 | 新的/严重/一般 |
| patientName | 患者姓名 | - |
| reactionName | 不良反应名称 | - |
| reactionTime | 发生时间 | - |
| reactionResult | 结果 | 痊愈/好转/未好转等 |
| departmentId_dictText | 上报科室 | - |
| createBy_dictText | 上报人 | 上报人姓名 |
| createTime | 上报时间 | - |

**操作按钮**:
- 查看: 查看报告详情（只读模式）
- 处理: 打开处理弹窗，选择处理方式

### 2. 待确认列表

**功能描述**:
- 展示所有状态为"整改中"(rectifying) 的药品不良反应报告
- 这些报告已由临床人员提交整改，等待药剂科确认

**列表额外字段**:

| 字段名 | 显示名称 | 说明 |
|-------|---------|------|
| rectifySubmitTime | 整改提交时间 | 临床人员提交整改的时间 |

**操作按钮**:
- 查看: 查看报告详情和整改内容
- 确认: 打开确认弹窗，选择确认通过或再次整改

### 3. 已结案列表

**功能描述**:
- 展示所有状态为"已结案"(closed) 的药品不良反应报告
- 只读查看，不可操作

**列表额外字段**:

| 字段名 | 显示名称 | 说明 |
|-------|---------|------|
| closeType | 结案方式 | 直接结案/整改结案 |
| closeTime | 结案时间 | - |
| closeUserId_dictText | 结案人 | - |

### 4. 处理弹窗

**弹窗组件**: DrugProcessModal.vue

**表单字段**:

| 字段名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| action | 单选 | 是 | close-直接结案 / require_rectify-要求整改 |
| comment | 多行文本 | 否 | 处理意见（直接结案时选填） |
| rectifyRequirement | 多行文本 | 要求整改时必填 | 整改要求内容 |
| rectifyDeadline | 日期 | 要求整改时必填 | 整改期限 |

### 5. 确认整改弹窗

**弹窗组件**: DrugConfirmRectifyModal.vue

**展示内容**:
- 整改要求信息
- 整改措施（临床人员填写）
- 附件（如有）

**表单字段**:

| 字段名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| action | 单选 | 是 | confirm-确认通过 / reject-再次整改 |
| comment | 多行文本 | 再次整改时必填 | 退回原因 |

## API 设计

### 1. 获取待处理列表

```
GET /adverse/drug/process/pending
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| pageNo | int | 否 | 页码，默认 1 |
| pageSize | int | 否 | 每页条数，默认 10 |
| reportCode | string | 否 | 报告编号筛选 |
| patientName | string | 否 | 患者姓名模糊查询 |
| departmentId | string | 否 | 上报科室筛选 |

### 2. 获取待确认列表

```
GET /adverse/drug/process/confirming
```

**请求参数**: 同待处理列表

### 3. 获取已结案列表

```
GET /adverse/drug/process/closed
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| pageNo | int | 否 | 页码，默认 1 |
| pageSize | int | 否 | 每页条数，默认 10 |
| reportCode | string | 否 | 报告编号筛选 |
| patientName | string | 否 | 患者姓名模糊查询 |
| closeType | string | 否 | 结案方式：direct-直接结案 / rectify-整改结案 |

### 4. 直接结案

```
POST /adverse/drug/process/close
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| id | string | 是 | 报告ID |
| comment | string | 否 | 结案意见 |

### 5. 要求整改

```
POST /adverse/drug/process/requireRectify
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| id | string | 是 | 报告ID |
| rectifyRequirement | string | 是 | 整改要求 |
| rectifyDeadline | date | 是 | 整改期限 |
| comment | string | 否 | 备注 |

### 6. 确认整改

```
POST /adverse/drug/process/confirmRectify
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| id | string | 是 | 报告ID |
| comment | string | 否 | 确认意见 |

### 7. 退回整改（再次整改）

```
POST /adverse/drug/process/rejectRectify
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| id | string | 是 | 报告ID |
| comment | string | 是 | 退回原因 |

### 8. 获取整改记录

```
GET /adverse/drug/process/rectifyHistory
```

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| reportId | string | 是 | 报告ID |

## 数据库设计

### 1. 药品不良反应报告表扩展字段

在现有 `drug_adverse_report` 表中添加以下字段：

```sql
-- 处理相关字段
ALTER TABLE drug_adverse_report ADD COLUMN process_user_id VARCHAR(32) COMMENT '处理人ID';
ALTER TABLE drug_adverse_report ADD COLUMN process_user_name VARCHAR(100) COMMENT '处理人姓名';
ALTER TABLE drug_adverse_report ADD COLUMN process_time DATETIME COMMENT '处理时间';
ALTER TABLE drug_adverse_report ADD COLUMN process_comment TEXT COMMENT '处理意见';

-- 结案相关字段
ALTER TABLE drug_adverse_report ADD COLUMN close_type VARCHAR(32) COMMENT '结案方式：direct-直接结案 / rectify-整改结案';
ALTER TABLE drug_adverse_report ADD COLUMN close_user_id VARCHAR(32) COMMENT '结案人ID';
ALTER TABLE drug_adverse_report ADD COLUMN close_user_name VARCHAR(100) COMMENT '结案人姓名';
ALTER TABLE drug_adverse_report ADD COLUMN close_time DATETIME COMMENT '结案时间';
ALTER TABLE drug_adverse_report ADD COLUMN close_comment TEXT COMMENT '结案意见';
```

### 2. 药品不良反应整改表

```sql
CREATE TABLE drug_adverse_rectify (
  id VARCHAR(32) PRIMARY KEY COMMENT '主键',
  report_id VARCHAR(32) NOT NULL COMMENT '关联报告ID',

  -- 整改要求（药剂科填写）
  requirement TEXT NOT NULL COMMENT '整改要求',
  deadline DATE NOT NULL COMMENT '整改期限',
  require_user_id VARCHAR(32) COMMENT '下发人ID',
  require_user_name VARCHAR(100) COMMENT '下发人姓名',
  require_time DATETIME COMMENT '下发时间',

  -- 整改措施（临床人员填写）
  measures TEXT COMMENT '整改措施',
  completion TEXT COMMENT '完成情况',
  submit_user_id VARCHAR(32) COMMENT '提交人ID',
  submit_user_name VARCHAR(100) COMMENT '提交人姓名',
  submit_time DATETIME COMMENT '提交时间',

  -- 确认结果（药剂科填写）
  confirm_result VARCHAR(32) COMMENT '确认结果：approved-通过 / rejected-退回',
  confirm_user_id VARCHAR(32) COMMENT '确认人ID',
  confirm_user_name VARCHAR(100) COMMENT '确认人姓名',
  confirm_time DATETIME COMMENT '确认时间',
  confirm_comment TEXT COMMENT '确认意见',

  -- 状态
  status VARCHAR(32) NOT NULL DEFAULT 'pending' COMMENT '状态：pending-待整改 / submitted-已提交 / approved-已通过 / rejected-已退回',

  -- 系统字段
  create_by VARCHAR(32) COMMENT '创建人',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  update_by VARCHAR(32) COMMENT '更新人',
  update_time DATETIME COMMENT '更新时间',
  del_flag INT DEFAULT 0 COMMENT '删除标记',
  tenant_id INT COMMENT '租户ID',

  INDEX idx_report_id (report_id),
  INDEX idx_status (status)
) COMMENT '药品不良反应整改表';
```

### 3. 状态字典扩展

在 `drug_adr_status` 字典中添加新状态：

| 字典值 | 字典名称 | 说明 |
|-------|---------|------|
| pending_rectify | 待整改 | 药剂科已下发整改要求 |
| rectifying | 整改中 | 临床人员已提交整改 |
| closed | 已结案 | 处理完成 |

### 4. 新增字典

**结案方式 (drug_adr_close_type)**:

| 字典值 | 字典名称 |
|-------|---------|
| direct | 直接结案 |
| rectify | 整改结案 |

**整改状态 (drug_adr_rectify_status)**:

| 字典值 | 字典名称 |
|-------|---------|
| pending | 待整改 |
| submitted | 已提交 |
| approved | 已通过 |
| rejected | 已退回 |

## 权限设计

### 菜单权限

| 权限ID | 权限编码 | 权限名称 | 说明 |
|--------|---------|---------|------|
| ae_drug_process | - | 药品科室处理 | 菜单权限 |

### 按钮权限

| 权限ID | 权限编码 | 权限名称 |
|--------|---------|---------|
| ae_drug_process_view | adverse:drugProcess:view | 查看报告详情 |
| ae_drug_process_close | adverse:drugProcess:close | 直接结案 |
| ae_drug_process_require | adverse:drugProcess:require | 要求整改 |
| ae_drug_process_confirm | adverse:drugProcess:confirm | 确认整改 |
| ae_drug_process_reject | adverse:drugProcess:reject | 退回整改 |

### 数据权限

- 药剂科人员可以查看所有待处理的药品不良反应报告
- 暂不做科室隔离（药品类统一由药剂科处理）

## 前端实现

### 新增组件

1. **页面组件**
   - `views/adverse/drug-process/index.vue` - 主页面
   - `views/adverse/drug-process/PendingList.vue` - 待处理列表
   - `views/adverse/drug-process/ConfirmingList.vue` - 待确认列表
   - `views/adverse/drug-process/ClosedList.vue` - 已结案列表
   - `views/adverse/drug-process/drugProcess.data.ts` - 表格配置

2. **弹窗组件**
   - `views/adverse/drug-process/components/DrugProcessModal.vue` - 处理弹窗
   - `views/adverse/drug-process/components/DrugConfirmRectifyModal.vue` - 确认整改弹窗
   - `views/adverse/drug-process/components/RectifyHistoryModal.vue` - 整改历史弹窗

3. **API 文件**
   - `api/adverse/drugProcess.ts` - 药品科室处理 API

### 路由配置

在 `adverse.ts` 路由文件中添加：

```typescript
// ========== 药品科室处理 ==========
{
  path: 'drug-process',
  name: 'AdverseDrugProcess',
  component: () => import('/@/views/adverse/drug-process/index.vue'),
  meta: {
    title: '药品科室处理',
    icon: 'ant-design:experiment-outlined',
  },
},
```

## 后端实现

### 新增 Controller

- `DrugProcessController.java` - 药品科室处理控制器

### 新增 Entity

- `DrugAdverseRectify.java` - 药品不良反应整改实体

### 新增 Service

- `IDrugAdverseRectifyService.java` - 整改服务接口
- `DrugAdverseRectifyServiceImpl.java` - 整改服务实现

### Service 扩展

在 `IDrugAdverseReportService` 中添加方法：
- `getPendingProcessList()` - 获取待处理列表
- `getConfirmingList()` - 获取待确认列表
- `getClosedList()` - 获取已结案列表
- `closeReport()` - 直接结案
- `requireRectify()` - 要求整改
- `confirmRectify()` - 确认整改
- `rejectRectify()` - 退回整改

## 任务拆分

### Phase 1: 数据库设计
1. 扩展 drug_adverse_report 表字段
2. 创建 drug_adverse_rectify 整改表
3. 添加状态字典项

### Phase 2: 后端开发
1. 创建 DrugAdverseRectify 实体类
2. 创建 DrugAdverseRectifyMapper
3. 创建 IDrugAdverseRectifyService 和实现
4. 创建 DrugProcessController
5. 扩展 DrugAdverseReportService 处理方法

### Phase 3: 前端开发
1. 创建 API 文件
2. 创建页面组件（待处理/待确认/已结案列表）
3. 创建处理弹窗和确认弹窗
4. 添加路由配置

### Phase 4: 权限配置
1. 创建菜单 SQL 脚本
2. 配置按钮权限
3. 分配角色权限

## 验收标准

- [ ] 药剂科人员可以查看所有待处理的药品不良反应报告
- [ ] 可以对报告进行"直接结案"操作
- [ ] 可以对报告进行"要求整改"操作，填写整改要求和期限
- [ ] 整改要求下发后，报告状态变为"待整改"
- [ ] 临床人员提交整改后，报告状态变为"整改中"
- [ ] 可以查看待确认列表，查看整改内容
- [ ] 可以确认整改通过，报告结案
- [ ] 可以退回整改，报告状态回到"待整改"
- [ ] 已结案列表可以查看所有已完成的报告
- [ ] 所有操作生成流转记录

---

> 由 /jeecg:prd 命令生成
> 创建时间: 2025-12-19
> 使用命令: /jeecg:plan 进行任务规划
